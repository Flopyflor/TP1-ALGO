% !TEX encoding = UTF-8 Unicode
\documentclass[10pt,a4paper]{article}

\input{AEDmacros}
\usepackage{caratula} % Version modificada para usar las macros de algo1 de ~> https://github.com/bcardiff/dc-tex

\titulo{Trabajo práctico 1: Especificación y WP}
\subtitulo{“Fondo Monetario Común”}

\fecha{\today}

\materia{Algoritmos y Estructuras de Datos/ Ex Algo 2}
\grupo{losdecompusongentedebien}

\integrante{Allami, Florencia}{484/23}{allamiflorencia@gmail.com}
\integrante{Bartoli, Matilda}{175/23}{bartoli.matilda@gmail.com}
\integrante{Simon, Felipe Pedro}{135/23}{felipe.p.simon@gmail.com}
\integrante{Sosa, Luciano}{1011/23}{sosaluciano261@gmail.com}
% Pongan cuantos integrantes quieran

\graphicspath{{../static/}}

\begin{document}

\maketitle

\section{Ejercicio 1}

\subsection{redistribucionDeLosFrutos}

\begin{proc}{redistribucionDeLosFrutos}{\In recursos: \TLista{\float}, \In cooperan: \TLista{\bool}}{\TLista{\float}}
	\requiere{\paraTodo[unalinea]{e}{\float}{e \in recursos \implica e > 0} \land \longitud{cooperan} = \longitud{recursos}}
	\asegura{|\res| = |recursos| \yLuego \\ \paraTodo[unalinea]{i}{\ent}{0 \leq i < |\res| \implicaLuego \IfThenElse{cooperan[i] = \True}{res[i] = \frac{fondoComun(recursos, cooperan)}{\longitud{recursos}}}{res[i] = recursos[i] + \frac{fondoComun(recursos, cooperan)}{\longitud{recursos}}}}} 
\end{proc}

\aux{fondoComun}{recursos: \TLista{\float}, cooperan: \TLista{\bool}}{\float}{ \\\sum\limits_{i=0}^{\longitud{recursos}-1} \IfThenElse{cooperan[i] = \True}{recursos[i]}{0}
}

\subsection{trayectoriaDeLosFrutosIndividualesALargoPlazo}

\begin{proc}{trayectoriaDeLosFrutosIndividualesALargoPlazo}{
	\Inout trayectorias: \TLista{\TLista{\float}}, \In cooperan: \TLista{\bool}, \In apuestas: \TLista{\TLista{\float}},
	\In pagos: \TLista{\TLista{\float}}, \In eventos: \TLista{\TLista{\nat}}
}{}

	\requiere{\\
		|trayectorias| = |eventos| = |cooperan| = |apuestas| = |pagos| \yLuego \\
		\paraTodo[unalinea]{i}{\ent}{0 \le i < |cooperan| \implicaLuego |trayectorias[i]| = 1 \land |apuestas[i]| = |pagos[i]|} \land \\
		\paraTodo[unalinea]{i}{\ent}{0 \le i < |eventos| \implicaLuego |eventos[i]| = |eventos[0]|} \land \\
		todosElementosDeLasListasPositivos(pagos) \land \\ todosElementosDeLasListasPositivos(trayectorias) \land \\
		eventosValidos(eventos, pagos) \land \\seApuestaTodo(apuestas)\\
	}
	
	\asegura{\\
		|trayectorias| = |eventos| \yLuego \\
		\paraTodo[unalinea]{i}{\ent}{0 \le i < |trayectorias| \implicaLuego |trayectorias[i]| = |eventos[0]|+1} \land \\
		elPrincipioSigueIgual(old(trayectorias), trayectorias) \land \\
		estaBienCalculado(trayectorias, eventos, cooperan, apuestas, pagos)\\
	}

\end{proc}

\pred{todosElementosDeLasListasPositivos}{pagos: \TLista{\TLista{\float}}}{
     \paraTodo[unalinea]{i}{\ent}{\paraTodo[unalinea]{t}{\ent}{0 \leq i<|pagos| \land 0\leq t <|pagos[i]|} \implicaLuego pagos[i][j] > 0}
}

\pred{eventosValidos}{eventos: \TLista{\TLista{\nat}}, pagos: \TLista{\TLista{\float}}}{
	\paraTodo[unalinea]{i}{\ent}{\paraTodo[unalinea]{t}{\ent}{0 \leq i<|eventos| \land 0\leq t <|eventos[i]| \implicaLuego eventos[i][t]<|pagos[i]|}}
}

\pred {seApuestaTodo}{apuestas:\TLista{\TLista{\float}}}{
    \paraTodo[unalinea]{i}{\ent}{0 \leq i<|apuestas| \implicaLuego \sum\limits_{t=0}^{|apuestas[i]-1|}{apuestas[i][t]}=1}}

\pred{elPrincipioSigueIgual}{oldtrayectorias: \TLista{\TLista{\float}}, trayectorias:\TLista{\TLista{\float}}}{
	\paraTodo[unalinea]{i}{\ent}{0 \leq i < |trayectorias|  \implicaLuego 
	oldtrayectorias[i][0] = trayectorias [i][0]}
}

\pred{estaBienCalculado}{trayectorias: \TLista{\TLista{\float}}, eventos: \TLista{\TLista{\nat}}, 
cooperan: \TLista{\bool}, apuestas: \TLista{\TLista{\float}}, \\ pagos: \TLista{\TLista{\float}}}{
	\paraTodo[unalinea]{i}{\ent}{\paraTodo[unalinea]{t}{\ent}{(0 \leq i < |cooperan| \land 0 < t \le |eventos[0]|) \\ \implicaLuego 
	trayectorias[i][t] = calcularPlataConFondo(i, t, cooperan, apuestas, pagos, eventos, trayectorias)}}
}

\aux{calcularPlataConFondo}{individuo: \nat, tiempo: \nat, cooperan: \TLista{\bool}, apuestas: \TLista{\TLista{\float}}, 
pagos: \TLista{\TLista{\float}}, eventos: \TLista{\TLista{\nat}}, trayectorias: \TLista{\TLista{\float}}}{\float}{ \\
	\IfThenElse{cooperan[individuo] = \True}{fondoDistribuido(tiempo, apuestas, pagos, eventos, trayectorias, cooperan) \\}
	{nuevaPlataSinFondo(individuo, tiempo, apuestas, pagos, eventos, trayectorias) \\
	+ fondoDistribuido(tiempo, apuestas, pagos, eventos, trayectorias, cooperan)}
}

\aux{nuevaPlataSinFondo}{individuo: \nat, tiempo: \nat, apuestas: \TLista{\TLista{\float}}, 
pagos: \TLista{\TLista{\float}}, eventos: \TLista{\TLista{\nat}}, \\ trayectorias: \TLista{\TLista{\float}}}
{\float}{\\
	apuesta[individuo][eventos[individuo][tiempo]] * pagos[individuo][eventos[individuo][tiempo]] \\ *trayectorias[individuo][tiempo - 1]
}

\aux{fondoDistribuido}{tiempo: \ent, apuestas: \TLista{\TLista{\float}}, pagos: \TLista{\TLista{\float}}, 
eventos: \TLista{\TLista{\ent}}, trayectorias: {\TLista{\TLista{\float}}}, cooperan: \TLista{\bool}}{\float}{ \\
	\sum\limits_{i=0}^{|cooperan|-1}{\IfThenElse{cooperan[i] = \True \\}
	{\frac{nuevaPlataSinFondo(i, tiempo, apuestas, pagos, eventos, trayectorias)}{|cooperan|} \\}{0}}
}

\subsection{trayectoriaExtrañaEscalera}

\begin{proc}{trayectoriaExtrañaEscalera}{\In trayectoria: \TLista{\float}}{\bool}
	\requiere{|trayectoria| \geq 1}
	\asegura{\res = true \iff hayUnSoloMaximoLocal(trayectoria)} 
\end{proc}

\pred {hayUnSoloMaximoLocal}{trayectoria: \TLista{\float}}{
    \existe[unalinea]{i}{\ent}{0 \leq i<|trayectoria| \yLuego esMaximoLocal(i, trayectoria) \land \\ \neg \existe[unalinea]{j}{\ent}{0 \leq j<|trayectoria| \yLuego j \neq i \land esMaximoLocal(j, trayectoria)}}}

\pred {esMaximoLocal}{i: \ent, trayectoria: \TLista{\float}}{
    |trayectoria| = 1 \oLuego \\ (i = 0 \land trayectoria[0] > trayectoria[1]) \lor \\ (|trayectoria| \geq 3 \yLuego trayectoria[i - 1] < trayectoria[i] >trayectoria[i + 1]) \oLuego \\ (i = |trayectoria| - 1 \land trayectoria[|trayectoria| - 1] > trayectoria[|trayectoria| - 2])}

\subsection{individuoDecideSiCooperarONo}

\begin{proc}{individuoDecideSiCooperarONo}{\In individuo: \nat, \In recursos: \TLista{\float}, \Inout cooperan: \TLista{\bool},
 \In apuestas: \TLista{\TLista{\float}}, \In pagos: \TLista{\TLista{\float}}, \In eventos: \TLista{\TLista{\nat}}}{}
	\requiere{\\
		|pagos|=|apuestas|=|eventos|=|cooperan|=|recursos| \land 0 \le individuo < |cooperan| \yLuego \\
		\paraTodo[unalinea]{i}{\ent}{0 \le i < |apuestas| \implicaLuego |apuestas[i]| = |pagos[i]| \land |eventos[0]| = |eventos[i]|} \yLuego \\
		eventosValidos(eventos, pagos) \land \\
		todosElementosDeLasListasPositivos(pagos) \land \\
		todosElementosDeLasListasPositivos(apuestas) \land \\
		\paraTodo[unalinea]{i}{\ent}{0 \le i < |recursos| \implicaLuego recursos[i] > 0} \\ % TODO: habíamos dicho que recuros != 0 no?
		}
		\asegura{ \\
		|old(cooperan)| = |cooperan| \yLuego \\
		soloSeActualizoElIndividuo(individuo, old(cooperan), cooperan) \land \\
		\IfThenElse{cooperan[individuo] = \True \\}
		{fondoDivididoEnTurno(|eventos|, eventos, cooperanSiCoopera(individuo, cooperan), recursos, pagos, apuestas) \ge 
		recursosDeNoCooperadorEnTurno(|eventos|, individuo, eventos, pagos, apuestas, \\ cooperanSiNoCoopera(individuo, cooperan), recursos) \\}
		{fondoDivididoEnTurno(|eventos|, eventos, cooperanSiCoopera(individuo, cooperan), recursos, pagos, apuestas) \le 
		recursosDeNoCooperadorEnTurno(|eventos|, individuo, eventos, pagos, apuestas, \\ cooperanSiNoCoopera(individuo, cooperan), recursos) \\}\\
	}

\end{proc}

\pred{soloSeActualizoElIndividuo}{individuo, cooperanV, cooperanN}{
	\paraTodo[unalinea]{i}{\ent}{0 \le i < |cooperanV| \land i \neq individuo \implicaLuego cooperanV[i] = cooperanN[i]}
}

\aux{fondoDivididoEnTurno}{turno: \ent, eventos: \TLista{\TLista{\ent}}, cooperan: \TLista{\bool}, 
recursos: \TLista{\float}, pagos: \TLista{\TLista{\float}}, apuestas: \TLista{\TLista{\float}}}{\float}{\\
recursosDeCooperadoresIniciales(cooperan, recursos) * (\prod\limits_{k=0}^{turno}{tasasDeCooperadores(k, cooperan, pagos, apuestas)})
}
\aux{cooperanSiCoopera}{individuo, cooperan}{\TLista{\bool}}{
	\\ \sub{cooperan, 0, individuo} \masmas \langle \True \rangle \masmas \sub{cooperan, individuo+1, |cooperan|}
}

\aux{cooperanSiNoCoopera}{individuo, cooperan}{\TLista{\bool}}{
	\\ \sub{cooperan, 0, individuo} \masmas \langle \False \rangle \masmas \sub{cooperan, individuo+1, |cooperan|}
}

\aux{tasasDeCooperadores}{turno: \ent, cooperan: \TLista{\bool}, pagos: \TLista{\TLista{\float}}, apuestas: \TLista{\TLista{\float}, eventos: \TLista{\TLista{\ent}}}}{}{
	\\ \sum\limits_{i=0}^{|cooperan|-1}{\IfThenElse{cooperan[i] = \True}{\frac{tasaEnTurno(turno, i, pagos, apuestas, eventos)}{|cooperan|}}{0}}
}

\aux{recursosDeCooperadoresIniciales}{cooperan: \TLista{\bool}, recursos: \TLista{\float}}{\float}{
	\\ \sum\limits_{i=0}^{|cooperan|}{\IfThenElse{cooperan[i] = \True}{\frac{recursos[i]}{|cooperan|}}{0}}
}

\aux{tasaEnTurno}{turno: \ent, individuo: \ent, pagos: \TLista{\TLista{\float}}, 
apuestas: \TLista{\TLista{\float}}, eventos: \TLista{\TLista{\ent}}}{\float}{ \\
	pagos[individuo][eventos[individuo][turno]]*apuestas[individuo][eventos[individuo][turno]]
}

\aux{recursosDeNoCooperadorEnTurno}{turno: \ent, individuo: \ent, eventos: \TLista{\TLista{\ent}}, 
pagos: \TLista{\TLista{\float}}, apuestas: \TLista{\TLista{\float}}, cooperan: \TLista{\bool}, recursos: \TLista{\TLista{\float}}}{}{\\
	recursos[individuo] * \prod\limits_{i=0}^{turno}{tasaEnTurno(turno, individuo, pagos, apuestas, eventos)} + \\
	\sum\limits_{i=0}^{turno}{(fondoDivididoEnTurno(i, eventos, cooperan, recursos, pagos, apuestas)} *\\
 	\prod\limits_{j=i+1}^{turno}{tasaEnTurno(j, individuo, pagos, apuestas, eventos)} \text{)} 
	% TODO: no estoy pudiendo poner un linebreak acá pq está dentro de una sumatoria
}

\subsection{individuoActualizaApuesta}

\begin{proc}{individuoActualizaApuesta}{\In individuo: \nat, \In recursos: \TLista{\float} , \In cooperan: \TLista{\bool} , \Inout apuestas: \TLista{\TLista{\float}}, \In pagos: \TLista{\TLista{\float}} , \In eventos: \TLista{\TLista{\nat}} }{}


\end{proc}

\pred{esApuestaSimilar}{i: \nat, apuestas: \TLista{\TLista{\float}}, s: \TLista{\TLista{\float}}}{
	(|apuestas| = |s|) \land \paraTodo[unalinea]{j}{\ent}{(0 \leq j < |apuestas|) \land  (j \neq i) \implicaLuego ( apuestas[j] = s[j] )}
}
\section{Ejercicio 2}
\begin{flushleft}
Queremos probar  la validez de la siguiente tripla de Hoare:
\textbf{\{ P \}S\{ Q \}} la cual es valida si solo si \textbf{{P $\implicaLuego$ wp(S,Q)}.}\\                                  
\vspace{3mm}
\textbf{P (precondición)}=$\{ apuesta_c + apuesta_s =1 \wedge pago_c>0 \wedge pago_s>0 \wedge apuesta_c>0 \wedge apuesta_s>0 \wedge recurso>0\}$\\
\vspace{3mm}
\textbf{Q (postcondición)}=\{res=recurso($apuesta_cpago_c)^{\#(eventos,T)}$($apuesta_spago_s)^{\#(eventos,F)}$\}\\
\vspace{34mm}
\textbf{S (programa)}=
\begin{lstlisting}
	res := recurso;
	i := 0;
	while (i < eventos.size()) do
	    if eventos[i]then
		   res:= (res.apuesta_c)pago_c
		else
		   res:= (res.apuesta_s)pago_s
		endif
		i := i + 1
	endwhile
		\end{lstlisting} 

\vspace{3mm}
\textbf{Dividimos el programa en tres partes (S1,S2,S3)}:\\
\begin{lstlisting}
	S1
	res := recurso;
	S2
	i := 0;
	S3
	while (i < eventos.size()) do
	     if eventos[i]then
		   res:= (res.apuesta_c)pago_c
		 else
		   res:= (res.apuesta_s)pago_s
		 endif
		i := i + 1
	endwhile
		\end{lstlisting} 

\vspace{3mm}
Luego, queriamos probar que P $\implicaLuego$ wp(S,Q).Esto es lo mismo que probar que P $\implicaLuego$ wp(S1,S2,S3,Q).\\
\vspace{3mm}
Primero debemos hallar \textbf{wp(S1,S2,S3,Q) $\equiv$ wp(s1,s2(wp(S3,Q)))}.\\
\vspace{3mm}
\textbf{wp(S3,Q)} = PC (precondición del ciclo)= \{res= recurso $\wedge$ i=0\}\\
\vspace{3mm}
\textbf{Demostración de la correcitud del ciclo:}\\
\vspace{3mm}
Para ello necesitamos: 
\begin{enumerate} \setlength\itemsep{0cm}
	\item \textbf{I (invariante)}= $0\leq i \leq |eventos| \wedge res=recurso(apuesta_cpago_c)^{\#(subseq(eventos,0,i),T)}(apuesta_spago_s)^{\#(subseq(eventos,0,i),F)}$
	\item \textbf{PC}= $\{res= recurso \wedge i=0\}$
	\item \textbf{QC (postcondición del ciclo)}= $\{res=recurso(apuesta_cpago_c)^{\#(eventos,T)}(apuesta_spago_s)^{\#(eventos,F)} \wedge i=|eventos|$\}
	\item \textbf{BC (guarda del ciclo)} = $i < |eventos|$
	\item \textbf{FV (función variante)} = $|eventos|-i$
\end{enumerate}

Luego, hay que demostrar:
\begin{enumerate} \setlength\itemsep{0cm}
	\item \textbf{$PC \implica I$}
	\item \textbf{$\{ I \wedge B \}S\{ I \}$}
	\item \textbf{$I \wedge \neg B \implica QC$}
	\item \textbf{$\{ I \wedge B \wedge Fv= vo \}S\{ Fv<Vo \}$}
	\item \textbf{$I \wedge FV\leq0 \implica \neg B$} 

\end{enumerate}

\begin{enumerate} \setlength\itemsep{4mm}
	\item \textbf{$PC \implica I$} \\
	\vspace{2mm}
	$res= recurso$ $\wedge$ i=0 $\implica 0\leq i\leq|eventos| \wedge$ res=recurso$(apuesta_cpago_c)^{\#(subseq(eventos,0,i),T)}(apuesta_spago_s)^{\#(subseq(eventos,0,i),F)} \equiv$\\
	\vspace{3mm}
	\textbf{(Asumo que vale PC (luego vale cada termino que lo compone))}.\\
	\vspace{3mm}
	\textbf{(Reemplazo en I a i por i=0 (ya que asumimos que vale))}.\\
	\vspace{3mm}
	$res= recurso$ $\wedge$ i=0 $\implica 0\leq 0\leq|eventos| \wedge$ $res=recurso$($apuesta_cpago_c)^{\#(subseq(eventos,0,0),T)}$($apuesta_spago_s)^{\#(subseq(eventos,0,0),F)}\equiv$\\
	\vspace{2mm}
	$res= recurso$ $\wedge$ i=0  $\implica$  True $ \wedge$ $res=recurso$($apuesta_cpago_c)^{\#(lista vacia,T)}$($apuesta_spago_s)^{\#(lista vacia,F)}\equiv$ \\
	\vspace{2mm}
	$res= recurso$ $\wedge$ i=0  $\implica$ $res=recurso$($apuesta_cpago_c)^{0}$($apuesta_spago_s)^{0} \equiv $\\
	\vspace{2mm}
	$res= recurso$ $\wedge$ i=0  $\implica$ $res=recurso$ $\equiv $\\
	\vspace{2mm}
	$res= recurso$ $\wedge$ i=0  $\implica$ True \\
	\vspace{3mm}
	\textbf{Luego, queda demostrado que PC $\implica$ I}.\\
	\item \textbf{$\{ I \wedge B \}S\{ I \}$}
	\item \textbf{$I \wedge \neg B \implica QC$}\\
	\vspace{2mm}
	$0\leq i \leq |eventos| \wedge res=recurso(apuesta_cpago_c)^{\#(subseq(eventos,0,i),T)}(apuesta_spago_s)^{\#(subseq(eventos,0,i),F)} \wedge i \geq |eventos| \implica QC \equiv $ \\
	\vspace{2mm}
	\textbf{(Como $i \leq |eventos| \wedge i\geq |eventos|$, luego $i=|eventos|$)}.\\
	\vspace{2mm}
	$i = |eventos| \wedge res=recurso(apuesta_cpago_c)^{\#(subseq(evento,0,i),T)}(apuesta_spago_s)^{\#(subseq(eventos,0,i),F)}  \implica QC \equiv $ \\
	\vspace{3mm}
	\textbf{(Asumo que vale PC (luego vale cada termino que lo compone))}.\\
	\vspace{3mm}
	\textbf{(Reemplazo en ($I \wedge \neg B $) a i por $i= |eventos|$ (ya que asumimos que vale))}.\\
	\vspace{3mm}
	$i = |eventos| \wedge res=recurso(apuesta_cpago_c)^{\#(subseq(eventos,0,|eventos|),T)}(apuesta_spago_s)^{\#(subseq(eventos,0,|eventos|),F)} \implica QC \equiv $ \\
	\vspace{2mm}
	$ i=|eventos| \wedge res=recurso(apuesta_cpago_c)^{\#(eventos,T)}(apuesta_spago_s)^{\#(eventos,F)} \implica QC \equiv $ \\
	\vspace{2mm}
	$QC \implica QC$ \\
	\vspace{3mm}
	\textbf{Luego, queda demostrado que $I \wedge \neg B \implica QC$}. \\
	\item \textbf{$\{ I \wedge B \wedge Fv= vo \}S\{ Fv<Vo \}$}
	\item \textbf{$I \wedge FV\leq0 \implica \neg B$} 



\end{enumerate}


\end{flushleft}

\end{document}
